#!/bin/sh -e

# bin/compile <build-dir> <cache-dir> <env-file>

dir_var ()
{
    eval "dir_path=\${$1}"
    echo Directory: $1=$dir_path
    if [ -f "Makefile" ]; then
        ls -la $dir_path
    else
        echo "<non-existent>"
    fi
}

report ()
{
    echo "-----> "$*
}

APP_BUILD_DIR=$1
APP_CACHE_DIR=$2
BUILDPACK_DIR=`cd $(dirname $0); cd ..; pwd`

dir_var APP_BUILD_DIR
dir_var APP_CACHE_DIR
dir_var BUILDPACK_DIR

mkdir -p $APP_CACHE_DIR

cd $APP_CACHE_DIR
    ln -sf $BUILD_PACK_DIR/bin
    ln -sf $BUILD_PACK_DIR/include
    ln -sf $BUILD_PACK_DIR/lib
cd -

cd $APP_BUILD_DIR
    if [ -f "Makefile" ]; then
        report "Makefile found."
        make CACHE_DIR=$CACHE_DIR
        report "Compilation successful."
    else
        report "Error: No Makefile found."
        exit 1
    fi
cd -
